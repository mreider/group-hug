<h1>Rails Tutorial + Facebook Connect</h1>

<ul>
<li>Install rails:</li>
<code>gem install rails</code>
<li>Create rails app:
rails new fbcomments</li>
<li>Install facebooker2 as a plugin in your rails app.
script/rails plugin install git://github.com/mmangino/facebooker2.git</li>
<li><p>Create facebook application at http://www.facebook.com/developers/createapp.php and set the site URL to your application URL. For example, ours is http://icanhazrails.com/</p></li>
<li><p>Create config/facebooker.yml with the appropriate environment.</p>

<p>development:
    app<em>id: <your application id>
    secret: <your application secret>
    api</em>key: <your application key></p>

<p>and possible test/production environment</p></li>
<li><p>Create config/initializers/facebooker2.rb and place the following line in it</p>

<p>Facebooker2.load<em>facebooker</em>yaml</p></li>
<li><p>Add the following line to your app/controllers/application_controller.rb</p>

<p>include Facebooker2::Rails::Controller</p></li>
<li><p>Update your rails applications to use the rails helpers. Lets put this code to page layout(views/layouts/application.html.erb) to display login button on every page or if user already loged in - his name</p>

<p>&lt;% # include JavaScript to use facebook connect%>
&lt;%= fb<em>connect</em>async_js %> </p>

<p>&lt;% if current<em>facebook</em>user !=nil %>
    &lt;%= &#8220;Welcome #{@current<em>user.name}!&#8221;  if @current</em>user !=nil %>
    &lt;%= fb<em>logout</em>link(&#8220;Logout&#8221;, request.url) %><br />
&lt;% else
    # we must explicitly request permissions for facebook user fields.
    # we need to get user&#8217;s email, groups, stream posts and post to groups or stream
    # also fb<em>login</em>and<em>redirect first parameter is redirect url after login attempt
    %>
    &lt;%= fb</em>login<em>and</em>redirect( url<em>for(:action => &#8216;create&#8217;, :controller => &#8216;home&#8217;, :only</em>path => false),
        :perms => &#8216;email,user<em>groups,read</em>stream, publish_stream&#8217;) %>
&lt;% end %></p></li>
<li><p>Create model to store application users</p>

<p>rails generate model User</p>

<p>and create migration like this:</p>

<p>class CreateUsers &lt; ActiveRecord::Migration
  def self.up
    create<em>table :users do |t|
      t.string :email, :name, :facebook</em>id, :facebook<em>session</em>key
      t.timestamps
    end
  end</p>

<p>def self.down
    drop_table :users
  end
end</p>

<p>then run migration via</p>

<p>rake db:migrate</p></li>
<li><p>Create Home controller and put there login and create user action</p>

<p>rails generate controller Home</p>

<p>just display empty page</p>

<p>def login
  end</p>

<p>view can be empty - login button already defined in the layout</p>

<p>create action must get parameters passed by facebook after user login
and create new user if it not exists. we can do it such way:</p>

<p>def create
    @user = User.find<em>by</em>email(params[:email])
    create<em>via</em>facebook_connect if @user.nil?</p>

<pre><code>if @user != nil 
  session[:user_id] = @user.id
  redirect_to url_for(groups_path)
  session[:return_to]=nil
else
  flash[:error] = "Unable to log you in"
  render :action=&gt;"login"
end
</code></pre>

<p>end</p>

<p>def create<em>via</em>facebook<em>connect
    if current</em>facebook<em>user 
      #look for an existing user
      @user = User.find</em>by<em>facebook</em>id(current<em>facebook</em>user.id) <br>
      if @user.nil?
        #if one isn&#8217;t found - fetch user data via Mogli lib and create new user
        current<em>facebook</em>user.fetch
        @user = User.new(:name => current<em>facebook</em>user[:name], :email => current<em>facebook</em>user[:email], :facebook<em>id => current</em>facebook<em>user[:id], :facebook</em>session<em>key => current</em>facebook<em>client.access</em>token)
        @user.save
      end
    end
  end</p></li>
<li><p>After successful login users will go to groups controller.  Lets create it and setup routes:</p>

<p>rails generate controller Groups</p>

<p>and edit config/routes.rb to add</p>

<p>resources :groups </p>

<p>set home page to login</p>

<p>root :to => &#8220;home#login&#8221;</p>

<p>and allow to use &#8216;<controller>/<action>&#8217; routes. Just uncomment last route</p>

<p>match &#8216;:controller(/:action(/:id(.:format)))&#8217;</p></li>
<li><p>Add methods to ApplicationController to check if user is logged in and determine user id:</p>

<p>def current<em>user
    if session[:user</em>id]
      @current<em>user ||= User.find(session[:user</em>id])
    elsif current<em>facebook</em>user and @current<em>user.nil?
      @current</em>user = User.find<em>by</em>facebook<em>id(current</em>facebook_user.id)
    end
  end</p>

<p>helper<em>method :current</em>user</p>

<p>def login<em>required
    if current</em>user.nil?
      flash[:notice] = &#8220;You must login to access this page&#8221;
      session[:return<em>to] = request.request</em>uri
      redirect_to :controller =>&#8217;home&#8217;, :action =>&#8217;login&#8217; and return
    end
  end</p></li>
<li><p>Implement GroupsController</p>

<p>def index 
    #get current users groups
    @groups = current<em>facebook</em>user.groups</p>

<pre><code>#determine selected user group or get first group id if default group is not selected
@default_group = @current_user.default_group
@default_group = @groups.first.id if @default_group.nil? &amp;&amp; @groups.first != nil
</code></pre>

<p>end</p></li>
<li><p>Implement goups view in app/views/groups/index.html.erb</p>

<pre><code>&lt;select name="group" id="group" &gt;
&lt;% @groups.each do |group| %&gt;
 &lt;option value="&lt;%=group.id%&gt;" &lt;%= 'selected' if @default_group == group.id %&gt;&gt;&lt;%=group.name%&gt;&lt;/option&gt;
&lt;% end %&gt;
&lt;/select&gt;


&lt;br/&gt;
&lt;input id="def_group" name="def_group" type="checkbox" selected="false" /&gt; Default group &lt;br/&gt;


&lt;div id="posts_container" &gt;Posts&lt;/div&gt;
</code></pre></li>
<li><p>Install jQuery via instructions at https://github.com/lleger/Rails-3-jQuery/ </p></li>
<li><p>Add placeholder for JavaScript at layout header</p>

<p><script> 
  &lt;%= yield (:javascript) %>
  </script></p>

<p>and create JavaScript to save default group</p>

<pre><code>&lt;% content_for (:javascript) do %&gt;
$(document).ready(function() {


  $('#def_group').bind('change', function() {
    var group_id = $(this).is(':checked') ? $('#group').val() : 'nil'
    $.post('/groups/default/' + group_id ,  function() {
      alert ('Default group was saved');
    });
  });


});  
&lt;% end %&gt;
</code></pre>

<p>So now we have combo box with all user groups.</p></li>
<li><p>Implement default group save in GroupsController</p>

<p>def default
    render :json => { :result => @current<em>user.update</em>attributes(:default_group => params[&#8216;id&#8217;] == &#8216;nil&#8217; ? nil : params[&#8216;id&#8217;]) }
  end</p></li>
<li><p>Implement Posts in current group displaying. </p>

<p>rails generate controller Groups</p>

<p>Lets use nested resouces to relate groups and posts. Setup routes this way:</p>

<p>resources :groups do
    resources :posts
  end</p></li>
<li><p>Call Posts List in groups view via jQuery:</p>

<p>Implement &#8216;change&#8217; event:</p>

<p>$(&#8216;#group&#8217;).bind(&#8216;change&#8217;, function() {
    $(&#8216;#posts<em>container&#8217;).load(&#8216;/groups/&#8217; + $(this).val() + &#8216;/posts&#8217;,  function() {
      FB.XFBML.parse(document.getElementById(&#8216;posts</em>container&#8217;));
    });
  });</p>

<p>And implement default group display on page load:</p>

<p>$(&#8216;#posts<em>container&#8217;).load(&#8216;/groups/&lt;%=@default</em>group%>/posts&#8217;,  function() {
    FB.XFBML.parse(document.getElementById(&#8216;posts_container&#8217;));</p>

<p>});</p>

<p>Posts controller will return user images in FBML, so we must parse FBML via FB.XFBML.parse</p></li>
<li><p>Posts list in selected group to insert via AJAX:</p>

<p>def index <br>
    @group = Mogli::Group.new({:id=>params[&#8216;group<em>id&#8217;]}, current</em>facebook_client)
    @group.fetch
    @posts = @group.feed
    render :layout => false
  end</p>

<p>view template can be like:</p>

<p>&lt;% @posts.each do |post| %></p>

<div style="clear:both">
  <span style="float:left;width:55px">
    <fb:profile-pic uid="<%=post.from.id%>" linked="false" size="q"></fb:profile-pic>
  </span>
  <span>
    <%=post.message%><br/> 
    <%=time_ago_in_words(post.updated_time) %> ago
  </span>
</div>

<p>&lt;% end %></p></li>
<li><p>Link to post new message used nested resource path:</p>

<p>&lt;%= link<em>to &#8220;Post&#8221;, url</em>for(new<em>group</em>post_path(@group.id)) %>  </p></li>
<li><p>Display form to post message to group. PostsController get current group to display name:</p>

<p>def new
    @group = Mogli::Group.new({:id=>params[&#8216;group<em>id&#8217;]}, current</em>facebook_client)
    @group.fetch
  end</p>

<p>and simple view:</p>

<h1 id="post_a_wall_message_to_">Post a wall message to: <%= @group.name %></h1>

<p>&lt;% form<em>tag  url</em>for(group<em>posts</em>path(@group.id)), :method=>:post do -%></p>

<p>&lt;%= hidden<em>field</em>tag &#8216;group_id&#8217;, @group.id %></p>

<p><div class="field">
    &lt;%= text<em>area</em>tag &#8216;message&#8217;, nil, :rows => 10, :cols => 60 %>
  </div>
  <div class="field">
    &lt;%= check<em>box</em>tag &#8216;send<em>via</em>email&#8217;, &#8216;yes&#8217;, true %> Send the whole group an email
  </div>
  <div class="actions">
    &lt;%= submit_tag &#8216;Save&#8217; %>
  </div>
&lt;% end -%></p>

<p>&lt;%= link<em>to &#8216;Back&#8217;, url</em>for(groups_path) %></p></li>
<li><p>Form submited to create action</p>

<p>def create
    @group = Mogli::Group.new({:id=>params[&#8216;group<em>id&#8217;]}, current</em>facebook_client)
    @group.fetch</p>

<pre><code>if current_facebook_user
  current_facebook_client.class.post(current_facebook_client.api_path(@group.id + '/feed'),
        :query=&gt;current_facebook_client.default_params.merge(
                   {:name =&gt; "#{current_facebook_user.name} Post a message using app!",
                    :link=&gt;'http://staging.operations.engineyard.com/groups',
                    :message=&gt;params['message']})).inspect
end
redirect_to groups_path
</code></pre>

<p>end</p></li>
<li><p>Run your app via &#8216;rackup&#8217; command</p></li>
</ul>
